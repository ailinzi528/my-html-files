<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map with Popup and Custom Icons</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { width: 100%; height: 100vh; }

        .mapboxgl-popup {
            background: rgba(255, 0, 0, 0.5);
            border-radius: 5px;
            padding: 5px;
            max-width: 400px;
            box-shadow: 0 0 0px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
        }

        .mapboxgl-popup-content {
            background: rgba(0, 0, 0, 0)!important;
            padding: 0;
            color: white;
        }

        .mapboxgl-popup img {
            max-width: 100%;
        }

        .mapboxgl-popup a {
            color: white!important;
            text-decoration: underline;
        }

        .caption {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 3px;
            color: #000;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            pointer-events: none;
            visibility: hidden;
            white-space: nowrap;
            z-index: 10;
            font: 12px/20px 'Open Sans', sans-serif;
        }

        .marker {
            display: block;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
        }
    </style>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
<div id="map"></div>
<div id="caption" class="caption"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWlsaW56aTUyOCIsImEiOiJjbHp0ZXQxZ3oyY2JuMnJyNHdxc2xndW94In0.1rfDN-c2Pjk5TztXwd0OLg';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/ailinzi528/clzs9eijl00e001pibjwi5e0o',
        center: [104.066, 30.650],
        zoom: 12
    });

    map.addControl(
        new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        }),
        'top-left'
    );

    map.addControl(new mapboxgl.NavigationControl(), 'top-left');

    map.on('load', function() {
        // Load and display polygons
        map.addSource('geojson-data', {
            type: 'geojson',
            data: 'wts2024_0814.geojson'
        });

        map.addLayer({
            id: 'polygons',
            type: 'fill',
            source: 'geojson-data',
            filter: ['==', '$type', 'Polygon'],
            paint: {
                'fill-color': '#888888',
                'fill-opacity': 0
            }
        });

        map.addLayer({
            'id': 'polygon-border',
            'type': 'line',
            'source': 'geojson-data',
            'filter': ['==', '$type', 'Polygon'],
            'paint': {
                'line-color': '#00ff88',
                'line-width': 6,
                'line-dasharray': [3, 3],
                'line-cap': 'round'
            }
        });

        map.addLayer({
            id: 'points',
            type: 'circle',
            source: 'geojson-data',
            filter: ['==', '$type', 'Point'],
            paint: {
                'circle-radius': 10,
                'circle-color': '#007cbf',
                'circle-opacity': 0
            }
        });

        // Load and display custom icons
        fetch('wts2024_png.geojson')
            .then(response => response.json())
            .then(data => {
                if (data.type === 'FeatureCollection') {
                    data.features.forEach(function (feature) {
                        if (feature.properties['0_png']) {
                            const el = document.createElement('div');
                            el.className = 'marker';
                            el.style.backgroundImage = `url(${feature.properties['0_png']})`;
                            el.style.width = '352px';
                            el.style.height = '528px';
                            el.style.backgroundSize = '100%';

                            new mapboxgl.Marker(el)
                                .setLngLat(feature.geometry.coordinates)
                                .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`
                                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">${feature.properties.name || ''}</div>
                                    <p style="margin-bottom: 10px;">${feature.properties['1_index'] || '#'}</p>
                                    <p style="margin-bottom: 10px;">${feature.properties.description || ''}</p>
                                    <img src="${feature.properties.img || ''}" alt="${feature.properties.name || ''}" style="width: 100%; height: auto; margin-bottom: 10px;">
                                    <a href="${feature.properties['3_link'] || '#'}" target="_blank" style="font: open sans; font-size: 14px; color: #007cbf; display: block; margin-top: 10px;">查看大图</a>
                                `))
                                .addTo(map);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error loading or parsing GeoJSON:', error);
            });

        // Handle point hover and click events
        map.on('click', 'points', function(e) {
            const features = e.features[0];
            const name = features.properties.name || '未命名';
            const img = features.properties.img || '';
            const index = features.properties['1_index'] || '#';
            const link = features.properties['3_link'] || '#';
            const description = features.properties.description || '';

            new mapboxgl.Popup({ offset: 25 })
                .setLngLat(e.lngLat)
                .setHTML(`
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">${name}</div>
                    <p style="margin-bottom: 10px;">${index}</p>
                    <p style="margin-bottom: 10px;">${description}</p>
                    <img src="${img}" alt="${name}" style="width: 100%; height: auto; margin-bottom: 10px;">
                    <a href="${link}" target="_blank" style="font: open sans; font-size: 14px; color: #007cbf; display: block; margin-top: 10px;">查看大图</a>
                `)
                .addTo(map);
        });

        map.on('mouseenter', 'points', function(e) {
            const features = e.features[0];
            const name = features.properties.name || '未命名';
            const index = features.properties['1_index'] || '#';

            const captionText = `${index} ${name}`;
            const coordinates = e.lngLat;

            const caption = document.getElementById('caption');
            caption.textContent = captionText;
            caption.style.visibility = 'visible';

            const pixelCoords = map.project(coordinates);
            caption.style.left = `${pixelCoords.x}px`;
            caption.style.top = `${pixelCoords.y}px`;
        });

        map.on('mouseleave', 'points', function() {
            const caption = document.getElementById('caption');
            caption.style.visibility = 'hidden';
        });

        map.on('mouseenter', 'points', function() {
            map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mouseleave', 'points', function() {
            map.getCanvas().style.cursor = '';
        });
    });
</script>
</body>
</html>

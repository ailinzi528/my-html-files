<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map with Popup and Caption</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { width: 100%; height: 100vh; }

        /* 自定义弹窗样式 */
        .mapboxgl-popup {
            background: rgba(255, 0, 0, 0.4); /* 弹窗背景颜色 */
            border-radius: 10px; /* 圆角 */
            padding: 5px; /* 内边距 */
            max-width: 400px; /* 最大宽度 */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* 阴影 */
            pointer-events: auto; /* 确保弹窗可点击 */
        }

        .mapboxgl-popup-content {
            background: rgba(0, 0, 0, 0)!important;  /* 内容区域背景颜色 */
            padding: 0; /* 去掉内容内边距 */
            color: white; /* 字体颜色 */
        }

        .mapboxgl-popup img {
            max-width: 100%; /* 确保图片不会超出弹窗的宽度 */
        }

        .mapboxgl-popup a {
            color: white; /* 链接颜色 */
            text-decoration: underline; /* 链接下划线 */
        }

        /* 自定义标题样式 */
        .caption {
            position: absolute; /* 绝对定位 */
            background: rgba(255, 255, 255, 0.8); /* 半透明背景 */
            padding: 5px; /* 内边距 */
            border-radius: 3px; /* 圆角 */
            color: #000; /* 字体颜色 */
            font-size: 14px; /* 字体大小 */
            font-weight: bold; /* 字体粗细 */
            text-align: center; /* 文字居中 */
            pointer-events: none; /* 确保标题不干扰鼠标事件 */
            visibility: hidden; /* 初始隐藏标题 */
            white-space: nowrap; /* 不换行 */
            z-index: 10; /* 确保标题在其他元素之上 */
        }
    </style>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
<div id="map"></div>
<div id="caption" class="caption"></div> <!-- 用于显示标题 -->

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWlsaW56aTUyOCIsImEiOiJjbHp0ZXQxZ3oyY2JuMnJyNHdxc2xndW94In0.1rfDN-c2Pjk5TztXwd0OLg';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/ailinzi528/clzs9eijl00e001pibjwi5e0o',
        center: [104.066, 30.650],
        zoom: 12
    });

    map.on('load', function() {
        // Add GeoJSON data source
        map.addSource('geojson-data', {
            type: 'geojson',
            data: 'wts2024_0814.geojson'
        });

        // Add layer for polygons
        map.addLayer({
            id: 'polygons',
            type: 'fill',
            source: 'geojson-data',
            filter: ['==', '$type', 'Polygon'],
            paint: {
                'fill-color': '#888888',
                'fill-opacity': 0
            }
        });

        // 添加边框虚线
        map.addLayer({
            'id': 'polygon-border',
            'type': 'line',
            'source': 'geojson-data',
            'filter': ['==', '$type', 'Polygon'],
            'paint': {
                'line-color': '#00ff88',
                'line-width': 5,
                'line-dasharray': [4, 4], // 虚线样式
                'line-cap': 'round' // 线条端点为圆角
            }
        });

        // Add layer for points
        map.addLayer({
            id: 'points',
            type: 'circle',
            source: 'geojson-data',
            filter: ['==', '$type', 'Point'],
            paint: {
                'circle-radius': 10,
                'circle-color': '#007cbf',
                'circle-opacity': 0
            }
        });

        // Add click event to display popup
        map.on('click', 'points', function(e) {
            const features = e.features[0];
            const name = features.properties.name || '未命名';
            const img = features.properties.img || '';
            const index = features.properties['1_index'] || '#';
            const link = features.properties['3_link'] || '#';
            const description = features.properties.description || '';

            new mapboxgl.Popup({ offset: 25 })
                .setLngLat(e.lngLat)
                .setHTML(`
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">${name}</div>
                    <p style="margin-bottom: 10px;">${index}</p>
                    <p style="margin-bottom: 10px;">${description}</p>
                    <img src="${img}" alt="${name}" style="width: 100%; height: auto; margin-bottom: 10px;">
                    <a href="${link}" target="_blank" style="font-size: 14px; color: #007cbf; display: block; margin-top: 10px;">查看大图</a>
                `)
                .addTo(map);
        });

        // Show caption on hover
        map.on('mouseenter', 'points', function(e) {
            const features = e.features[0];
            const name = features.properties.name || '未命名';
            const index = features.properties['1_index'] || '#';
            
            const captionText = `${index} ${name}`;
            const coordinates = e.lngLat;

            // Update caption content and position
            const caption = document.getElementById('caption');
            caption.textContent = captionText;
            caption.style.visibility = 'visible';
            
            // Calculate the pixel coordinates for the caption
            const pixelCoords = map.project(coordinates);
            caption.style.left = `${pixelCoords.x}px`;
            caption.style.top = `${pixelCoords.y}px`;
        });

        // Hide caption on mouse leave
        map.on('mouseleave', 'points', function() {
            const caption = document.getElementById('caption');
            caption.style.visibility = 'hidden';
        });

        // Change cursor to pointer on hover
        map.on('mouseenter', 'points', function() {
            map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mouseleave', 'points', function() {
            map.getCanvas().style.cursor = '';
        });
    });
</script>
</body>
</html>
